name: SonarQube PR Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
      - master

permissions:
  pull-requests: write
  contents: read
  checks: write

jobs:
  sonarqube-scan:
    name: SonarQube Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests with coverage
        run: npm run test -- --coverage --watchAll=false || true
        continue-on-error: true
        
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }}
            -Dsonar.projectName=${{ github.event.repository.name }}
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx
            -Dsonar.exclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx,**/node_modules/**,**/dist/**,**/build/**,**/coverage/**
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.typescript.tsconfigPath=tsconfig.json
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
            -Dsonar.pullrequest.branch=${{ github.event.pull_request.head.ref }}
            -Dsonar.pullrequest.base=${{ github.event.pull_request.base.ref }}
            -Dsonar.scm.provider=git
            
      - name: Wait for Quality Gate
        id: sonarqube-quality-gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          
      - name: Save SonarQube results
        if: always()
        run: |
          mkdir -p sonar-results
          echo "Quality Gate Status: ${{ steps.sonarqube-quality-gate.outputs.quality-gate-status }}" > sonar-results/summary.txt
          echo "Project Status: ${{ steps.sonarqube-quality-gate.outputs.project-status }}" >> sonar-results/summary.txt
          
      - name: Upload SonarQube results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sonarqube-results
          path: sonar-results/
          retention-days: 30
          
  sonarqube-report:
    name: Generate SonarQube Report
    needs: sonarqube-scan
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download SonarQube results
        uses: actions/download-artifact@v4
        with:
          name: sonarqube-results
          path: sonar-results/
          
      - name: Fetch SonarQube metrics and issues
        id: fetch-metrics
        run: |
          PROJECT_KEY="${{ github.repository_owner }}_${{ github.event.repository.name }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Fetch measures from SonarQube API
          MEASURES=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "${{ secrets.SONAR_HOST_URL }}/api/measures/component?component=${PROJECT_KEY}&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,security_hotspots,reliability_rating,security_rating,sqale_rating&pullRequest=${PR_NUMBER}")
          
          # Fetch detailed issues (bugs, vulnerabilities, code smells)
          ISSUES=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "${{ secrets.SONAR_HOST_URL }}/api/issues/search?componentKeys=${PROJECT_KEY}&pullRequest=${PR_NUMBER}&resolved=false&statuses=OPEN,CONFIRMED,REOPENED&ps=100")
          
          # Fetch quality gate status
          QG_STATUS=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "${{ secrets.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=${PROJECT_KEY}&pullRequest=${PR_NUMBER}")
          
          echo "measures<<EOF" >> $GITHUB_OUTPUT
          echo "$MEASURES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "issues<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "quality_gate<<EOF" >> $GITHUB_OUTPUT
          echo "$QG_STATUS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Parse and summarize results
        id: summarize
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          # Parse metrics
          MEASURES='${{ steps.fetch-metrics.outputs.measures }}'
          ISSUES='${{ steps.fetch-metrics.outputs.issues }}'
          QG_STATUS='${{ steps.fetch-metrics.outputs.quality_gate }}'
          
          # Extract metric values
          BUGS=$(echo "$MEASURES" | jq -r '.component.measures[] | select(.metric=="bugs") | .value // "0"')
          VULNERABILITIES=$(echo "$MEASURES" | jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value // "0"')
          CODE_SMELLS=$(echo "$MEASURES" | jq -r '.component.measures[] | select(.metric=="code_smells") | .value // "0"')
          COVERAGE=$(echo "$MEASURES" | jq -r '.component.measures[] | select(.metric=="coverage") | .value // "N/A"')
          DUPLICATIONS=$(echo "$MEASURES" | jq -r '.component.measures[] | select(.metric=="duplicated_lines_density") | .value // "N/A"')
          HOTSPOTS=$(echo "$MEASURES" | jq -r '.component.measures[] | select(.metric=="security_hotspots") | .value // "0"')
          
          # Quality Gate status
          QG_RESULT=$(echo "$QG_STATUS" | jq -r '.projectStatus.status // "UNKNOWN"')
          
          # Start building the summary
          cat > summary.md << 'HEADER'
          ## üîç SonarQube Analysis Results
          
          HEADER
          
          if [ "$QG_RESULT" = "OK" ]; then
            echo "### Quality Gate: ‚úÖ PASSED" >> summary.md
          else
            echo "### Quality Gate: ‚ùå FAILED" >> summary.md
          fi
          
          cat >> summary.md << METRICS
          
          **Pull Request:** #${{ github.event.pull_request.number }}
          **Branch:** \`${{ github.event.pull_request.head.ref }}\`
          
          ---
          
          ### üìä Code Quality Metrics
          
          | Metric | Value |
          |--------|-------|
          | üêõ Bugs | ${BUGS} |
          | üîí Vulnerabilities | ${VULNERABILITIES} |
          | üí° Code Smells | ${CODE_SMELLS} |
          | üî• Security Hotspots | ${HOTSPOTS} |
          | üìà Coverage | ${COVERAGE}% |
          | üìã Duplications | ${DUPLICATIONS}% |
          
          METRICS
          
          # Parse and display issues if quality gate failed
          ISSUE_COUNT=$(echo "$ISSUES" | jq -r '.total // 0')
          
          if [ "$ISSUE_COUNT" -gt 0 ]; then
            cat >> summary.md << 'ISSUES_HEADER'
          
          ---
          
          ### üö® Issues Found
          
          ISSUES_HEADER
            
            # Group issues by severity
            BLOCKER_COUNT=$(echo "$ISSUES" | jq '[.issues[] | select(.severity=="BLOCKER")] | length')
            CRITICAL_COUNT=$(echo "$ISSUES" | jq '[.issues[] | select(.severity=="CRITICAL")] | length')
            MAJOR_COUNT=$(echo "$ISSUES" | jq '[.issues[] | select(.severity=="MAJOR")] | length')
            MINOR_COUNT=$(echo "$ISSUES" | jq '[.issues[] | select(.severity=="MINOR")] | length')
            
            cat >> summary.md << ISSUE_SUMMARY
          **Total Issues:** ${ISSUE_COUNT}
          - üî¥ Blocker: ${BLOCKER_COUNT}
          - üü† Critical: ${CRITICAL_COUNT}
          - üü° Major: ${MAJOR_COUNT}
          - üîµ Minor: ${MINOR_COUNT}
          
          ISSUE_SUMMARY
            
            # Display top issues (limit to 20 for PR comment readability)
            echo "$ISSUES" | jq -r '.issues[:20] | .[] | 
            "#### " + (if .severity == "BLOCKER" then "üî¥" elif .severity == "CRITICAL" then "üü†" elif .severity == "MAJOR" then "üü°" else "üîµ" end) + " " + .severity + " - " + (.type | gsub("_"; " ")) + "\n" +
            "**Message:** " + .message + "\n" +
            "**File:** `" + .component + "`\n" +
            (if .line then "**Line:** " + (.line | tostring) + "\n" else "" end) +
            (if .rule then "**Rule:** " + .rule + "\n" else "" end) +
            "\n---\n"' >> summary.md
            
            if [ "$ISSUE_COUNT" -gt 20 ]; then
              REMAINING=$((ISSUE_COUNT - 20))
              echo "" >> summary.md
              echo "> **Note:** Showing top 20 issues. ${REMAINING} more issues found. View full report in SonarQube." >> summary.md
            fi
          fi
          
          # Add links section
          cat >> summary.md << FOOTER
          
          ---
          
          ### üîó Links
          
          - [üìä View Full Report in SonarQube](${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ github.repository_owner }}_${{ github.event.repository.name }}&pullRequest=${{ github.event.pull_request.number }})
          - [üéØ Quality Gate Details](${{ secrets.SONAR_HOST_URL }}/project/quality_gate?id=${{ github.repository_owner }}_${{ github.event.repository.name }})
          - [üêõ All Issues](${{ secrets.SONAR_HOST_URL }}/project/issues?id=${{ github.repository_owner }}_${{ github.event.repository.name }}&pullRequest=${{ github.event.pull_request.number }})
          
          ---
          
          <details>
          <summary>üìù View Raw Analysis Data</summary>
          
          **Measures:**
          \`\`\`json
          ${MEASURES}
          \`\`\`
          
          **Quality Gate:**
          \`\`\`json
          ${QG_STATUS}
          \`\`\`
          
          </details>
          FOOTER
          
          echo "summary_created=true" >> $GITHUB_OUTPUT
          echo "issue_count=${ISSUE_COUNT}" >> $GITHUB_OUTPUT
          
      - name: Comment PR with results
        uses: actions/github-script@v7
        if: steps.summarize.outputs.summary_created == 'true'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üîç SonarQube Analysis Results')
            );
            
            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }
            
      - name: Create Check Run with Detailed Output
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const qualityGateStatus = '${{ needs.sonarqube-scan.result }}';
            const conclusion = qualityGateStatus === 'success' ? 'success' : 'failure';
            const issueCount = '${{ steps.summarize.outputs.issue_count }}' || '0';
            
            // Read the full summary for detailed output
            let detailedText = '';
            try {
              detailedText = fs.readFileSync('summary.md', 'utf8');
            } catch (error) {
              detailedText = `View detailed results at: ${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ github.repository_owner }}_${{ github.event.repository.name }}&pullRequest=${{ github.event.pull_request.number }}`;
            }
            
            let summaryText = '';
            if (conclusion === 'success') {
              summaryText = '‚úÖ All quality checks passed! No critical issues found.';
            } else {
              summaryText = `‚ùå Quality Gate failed with ${issueCount} issue(s) found. Please review and fix the issues below.`;
            }
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'SonarQube Quality Gate',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: `Quality Gate ${conclusion === 'success' ? 'Passed ‚úÖ' : 'Failed ‚ùå'}`,
                summary: summaryText,
                text: detailedText
              }
            });
            
      - name: Fail workflow if quality gate failed
        if: needs.sonarqube-scan.result != 'success'
        run: |
          echo "::error::SonarQube Quality Gate failed!"
          exit 1
